#include "armada-388-clearfog-base.dts"

&w25q32 {
	status = "okay";
	/* FIXME: need to ensure that CS2 is high when probing for this... */
};

/ {
	clocks {
		spi_uart_clk: osc_max14830 {
			compatible = "fixed-clock";
			#clock-cells = <0>;
			clock-frequency = <3686400>;
		};
	};

	soc {
		internal-regs {
			sdhci@d8000 {
				/delete-property/ cd-gpios;
				broken-cd;
			};
		};
	};

	gpio_i2c {
		compatible = "i2c-gpio";
		sda-gpios = <&gpio0 25 (GPIO_ACTIVE_HIGH | GPIO_OPEN_DRAIN)>;
		scl-gpios = <&gpio0 24 (GPIO_ACTIVE_HIGH | GPIO_OPEN_DRAIN)>;
		i2c-gpio.delay-us = <1>;
		#address-cells = <1>;
		#size-cells = <0>;
	};
};

&uart1_pins {
	status = "disabled";
};

&uart1 {
	status = "disabled";
};

&gpio1 {
	spi_int {
		/* MPP54: this needs an external pull-up */
		gpio-hog;
		gpios = <22 GPIO_ACTIVE_HIGH>;
		input;
		line-name = "SPI-INT";
	};
};

&spi1 {
	cs-gpios = <0>, <&gpio0 22 GPIO_ACTIVE_HIGH>, <0>, <&gpio0 29 GPIO_ACTIVE_HIGH>;

	max14830: max14830@2 {
		compatible = "maxim,max14830";
		reg = <2>;
		clocks = <&spi_uart_clk>;
		clock-names = "xtal";
		interrupt-parent = <&gpio1>;
		interrupts = <22 IRQ_TYPE_LEVEL_LOW>;
		gpio-controller;
		#gpio-cells = <2>;
		spi-max-frequency = <26000000>;

		gpio-line-names =
			"EVM-GPIO0",
			"",
			"",
			"EVM-LED1",
			"EVM-GPIO4",
			"",
			"",
			"EVM-LED2",
			"EVM-GPIO8",
			"",
			"",
			"EVM-LED3",
			"EVM-GPIO12",
			"",
			"",
			"EVM-LED4"
			;
	};

	gpio_spi_chips: gpio@1 {
		compatible = "microchip,mcp23s17";
		reg = <1>;
		interrupt-parent = <&gpio1>;
		interrupts = <22 IRQ_TYPE_LEVEL_LOW>;
		interrupt-controller;
		#interrupt-cells = <2>;
		gpio-controller;
		#gpio-cells = <2>;
		microchip,spi-present-mask = <0x06>; /* extra addresses 1 and 2 */
		microchip,irq-mirror;
		drive-open-drain;
		spi-max-frequency = <10000000>;

		gpio-line-names =
			"OCM-HS_out",
			"OCM-HS_in",
			"1-A2",
			"1-A3",
			"1-A4",
			"1-A5",
			"1-A6",
			"1-A7",

			"1-B0",
			"1-B1",
			"1-B2",
			"1-B3",
			"1-B4",
			"1-B5",
			"1-B6",
			"1-B7",

			"2-A0",
			"2-A1",
			"2-A2",
			"2-A3",
			"2-A4",
			"2-A5",
			"2-A6",
			"2-A7",

			"2-B0",
			"2-B1",
			"2-B2",
			"2-B3",
			"2-B4",
			"2-B5",
			"2-B6",
			"2-B7"
			;

		/* activate all pull-ups to prevent floating inputs */
		mcp23s17_pullups: pinmux {
			pins =
				"gpio0",
				"gpio1",
				"gpio2",
				"gpio3",
				"gpio4",
				"gpio5",
				"gpio6",
				"gpio7",
				"gpio8",
				"gpio9",
				"gpio10",
				"gpio11",
				"gpio12",
				"gpio13",
				"gpio14",
				"gpio15",
				"gpio16",
				"gpio17",
				"gpio18",
				"gpio19",
				"gpio20",
				"gpio21",
				"gpio22",
				"gpio23",
				"gpio24",
				"gpio25",
				"gpio26",
				"gpio27",
				"gpio28",
				"gpio29",
				"gpio30",
				"gpio31";
			bias-pull-up;
		};
	};

	spidev@3 {
		compatible = "spidev";
		reg = <3>;
		spi-max-frequency = <12000000>;
		// NOTE: the HW appears to have troubles with CPOL=1 toggling -> let's use a physical invertor
		linux,spi-wdelay = /bits/ 16 <3>;
	};
};
